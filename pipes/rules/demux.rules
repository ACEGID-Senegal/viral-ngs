"""
    This is a basic framework for demultiplexing viral read data from
    the Broad Institute's walk-up sequencing platform.
"""

__author__ = 'Kristian Andersen <andersen@broadinstitute.org>, Daniel Park <dpark@broadinstitute.org>'

from snakemake.utils import makedirs
import os, os.path, time



'''
Basically the inputs are:
 - a tabular file describing sample name, library #, run #, barcode1 seq, and barcode2 seq
    for each sample. One such tab file per lane.
 - the flowcell ID and lane number
 - the Bustard directory (ask the person who did the run)



#-------- DEMULTIPLEXING OF MISEQ AND HISEQ DATA @ BROAD --------#

mkdir -p data/1 data/2 data/combined tmp/1 tmp/2 logs reports

bin/broad_utils.py get_bustard_dir /seq/walkup/picard/HAVA0ADXX
ln -s /seq/illumina/proc/SL-HDE/141205_SL-HDE_0500_AHAVA0ADXX data/bustard


# EXTRACT ILLUMINA BARCODES
bin/broad_utils.py make_barcodes_file data/samples.AHAVA0ADXX.txt data/barcodes.AHAVA0ADXX.1.txt
bin/broad_utils.py make_barcodes_file data/samples.AHAVA0ADXX.txt data/barcodes.AHAVA0ADXX.2.txt

bsub -R "rusage[mem=16]" -W 4:00 -oo logs/LSF-extract_barcodes-1.txt bin/broad_utils.py extract_barcodes data/bustard 1 data/barcodes.AHAVA0ADXX.1.txt tmp/1 --outMetrics=reports/barcodes-metrics-1.txt
bsub -R "rusage[mem=16]" -W 4:00 -oo logs/LSF-extract_barcodes-2.txt bin/broad_utils.py extract_barcodes data/bustard 2 data/barcodes.AHAVA0ADXX.2.txt tmp/2 --outMetrics=reports/barcodes-metrics-2.txt


# CONVERT RAW FILES TO BAM
bin/broad_utils.py make_params_file data/samples.AHAVA0ADXX.txt /idi/sabeti-scratch/dpark/ebov/sl-batch3-demux/data/1 data/params.AHAVA0ADXX.1.txt
bin/broad_utils.py make_params_file data/samples.AHAVA0ADXX.txt /idi/sabeti-scratch/dpark/ebov/sl-batch3-demux/data/2 data/params.AHAVA0ADXX.2.txt

bsub -R "rusage[mem=100]" -w 4021130 -q flower -oo logs/LSF-illumina_basecalls-1.txt bin/broad_utils.py illumina_basecalls data/bustard tmp/1 AHAVA0ADXX 1 data/params.AHAVA0ADXX.1.txt
bsub -R "rusage[mem=100]" -w 4021131 -q flower -oo logs/LSF-illumina_basecalls-2.txt bin/broad_utils.py illumina_basecalls data/bustard tmp/2 AHAVA0ADXX 2 data/params.AHAVA0ADXX.2.txt


# MERGE BAM FILES
# for each sample:
    bin/read_utils.py merge_bams data/1/{sample}.bam data/2/{sample}.bam data/combined/{sample}.bam

'''